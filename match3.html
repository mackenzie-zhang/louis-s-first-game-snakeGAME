<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LouisÁöÑÂΩ©ËôπÊ∂àÊ∂à‰πê</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 50%, #FFE4E1 100%);
            font-family: Arial, sans-serif;
            touch-action: none;
            overflow: hidden;
        }
        
        .game-container {
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            max-width: 95vw;
        }
        
        h1 {
            color: #5a67d8;
            margin: 10px 0;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .game-info {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .info-item {
            background: #f7fafc;
            padding: 10px 20px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .score {
            font-size: 24px;
            color: #5a67d8;
            font-weight: bold;
        }
        
        .moves {
            font-size: 24px;
            color: #e53e3e;
            font-weight: bold;
        }
        
        .level {
            font-size: 24px;
            color: #48bb78;
            font-weight: bold;
        }
        
        #gameBoard {
            display: inline-grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            gap: 5px;
            background: #e2e8f0;
            padding: 10px;
            border-radius: 15px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.1);
            touch-action: none;
        }
        
        .gem {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            user-select: none;
            -webkit-user-select: none;
            position: relative;
            border: 3px solid #fff;
            overflow: hidden;
        }
        
        .gem img {
            width: 90%;
            height: 90%;
            object-fit: contain;
        }
        
        .gem:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        
        .gem.selected {
            animation: pulse 0.5s infinite;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.8);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .gem.matched {
            animation: disappear 0.5s ease-out;
        }
        
        @keyframes disappear {
            0% { 
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            25% {
                transform: scale(1.3) rotate(90deg);
            }
            50% {
                transform: scale(1.5) rotate(180deg);
            }
            75% {
                transform: scale(1.2) rotate(270deg);
            }
            100% { 
                transform: scale(0) rotate(360deg);
                opacity: 0;
            }
        }
        
        .labubu-eyes {
            position: absolute;
            top: 35%;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            text-align: center;
            font-size: 12px;
            pointer-events: none;
        }
        
        .gem.falling {
            animation: fall 0.5s ease-in;
        }
        
        @keyframes fall {
            0% { transform: translateY(-100px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            background: #5a67d8;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 18px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #667eea;
            transform: scale(1.05);
        }
        
        .special-button {
            background: #48bb78;
        }
        
        .special-button:hover {
            background: #38a169;
        }
        
        .game-over {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            text-align: center;
            z-index: 1000;
        }
        
        .game-over h2 {
            color: #5a67d8;
            margin-bottom: 20px;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        .combo-popup {
            position: absolute;
            font-size: 30px;
            font-weight: bold;
            color: #ff6b6b;
            animation: comboAnim 1s ease-out;
            pointer-events: none;
            z-index: 100;
        }
        
        @keyframes comboAnim {
            0% {
                transform: scale(0.5) translateY(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.5) translateY(-20px);
                opacity: 1;
            }
            100% {
                transform: scale(1) translateY(-50px);
                opacity: 0;
            }
        }
        
        @media (max-width: 768px) {
            #gameBoard {
                grid-template-columns: repeat(8, 40px);
                grid-template-rows: repeat(8, 40px);
                gap: 3px;
                padding: 5px;
            }
            
            .gem {
                width: 40px;
                height: 40px;
                font-size: 25px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .score, .moves, .level {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üéÄ LouisÁöÑLABUBUÂÆ∂ÊóèÊ∂àÊ∂à‰πê üéÄ</h1>
        <p style="color: #666; margin-top: -10px; font-size: 14px;">POPMARTÊ≠£ÁâàÊéàÊùÉÁ≥ªÂàó</p>
        
        <div class="game-info">
            <div class="info-item">
                <div class="level">Á¨¨ <span id="level">1</span> ÂÖ≥</div>
            </div>
            <div class="info-item">
                <div class="score">ÂæóÂàÜ: <span id="score">0</span></div>
            </div>
            <div class="info-item">
                <div class="moves">Ê≠•Êï∞: <span id="moves">30</span></div>
            </div>
        </div>
        
        <div id="gameBoard"></div>
        
        <div class="controls">
            <button onclick="newGame()">Êñ∞Ê∏∏Êàè</button>
            <button class="special-button" onclick="shuffleBoard()">È≠îÊ≥ïÊ¥óÁâå (3Ê¨°)</button>
            <button onclick="showHint()">LABUBUÊèêÁ§∫</button>
            <button onclick="showCollection()">ÊàëÁöÑÊî∂Ëóè</button>
        </div>
        
        <div style="margin-top: 15px; color: #666; font-size: 13px; line-height: 1.8; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 10px;">
            <p><strong>üéÅ POPMART LABUBUÈôêÈáèÁ≥ªÂàóÔºö</strong></p>
            <p style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                <span style="background: #FF69B4; color: white; padding: 2px 8px; border-radius: 10px;">THE MONSTERS</span>
                <span style="background: #FF0000; color: white; padding: 2px 8px; border-radius: 10px;">Coca-ColaËÅîÂêç</span>
                <span style="background: #87CEEB; color: white; padding: 2px 8px; border-radius: 10px;">Lazy Yoga</span>
                <span style="background: #FFD700; color: #333; padding: 2px 8px; border-radius: 10px;">SpongeBob</span>
                <span style="background: #98FB98; color: #333; padding: 2px 8px; border-radius: 10px;">Fall In Wild</span>
                <span style="background: #DDA0DD; color: white; padding: 2px 8px; border-radius: 10px;">Wings of Fortune</span>
                <span style="background: #C0C0C0; color: #333; padding: 2px 8px; border-radius: 10px;">Almost Hidden</span>
            </p>
        </div>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div class="game-over" id="gameOver">
        <h2 id="gameOverTitle">Ê∏∏ÊàèÁªìÊùüÔºÅ</h2>
        <p>ÊúÄÁªàÂæóÂàÜ: <span id="finalScore">0</span></p>
        <p id="gameOverMessage"></p>
        <p>Êî∂ÈõÜÂà∞ <span id="collectedCount">0</span> Ê¨æLABUBUÔºÅ</p>
        <button onclick="newGame()">ÂÜçÁé©‰∏ÄÊ¨°</button>
    </div>
    
    <div class="game-over" id="collectionModal" style="display: none;">
        <h2>üéÅ ÊàëÁöÑLABUBUÊî∂Ëóè</h2>
        <div id="collectionList"></div>
        <button onclick="closeCollection()">ÂÖ≥Èó≠</button>
    </div>
    
    <div class="overlay" id="overlay"></div>
    <div class="game-over" id="gameOver">
        <h2 id="gameOverTitle">Ê∏∏ÊàèÁªìÊùüÔºÅ</h2>
        <p>ÊúÄÁªàÂæóÂàÜ: <span id="finalScore">0</span></p>
        <p id="gameOverMessage"></p>
        <button onclick="newGame()">ÂÜçÁé©‰∏ÄÊ¨°</button>
    </div>

    <script>
        const BOARD_SIZE = 8;
        // ‰ΩøÁî®ÂõæÁâáË∑ØÂæÑ‰ª£Êõøemoji
        const GEM_TYPES = [
            'images/labubu1.png',
            'images/labubu2.png', 
            'images/labubu3.png',
            'images/labubu4.png',
            'images/labubu5.png',
            'images/labubu6.png',
            'images/labubu7.png'
        ];
        const LABUBU_NAMES = [
            'THE MONSTERS ÁªèÂÖ∏Ê¨æ',
            'ÈáéÁîüÊé¢Èô©Ê¨æ', 
            '‰∏áÂú£ËäÇÊ¨æ',
            'ÂÜ¨Êó•Ê¨æ',
            'ÂõΩÁéãÊ¨æ',
            'Á¥´Ëâ≤Ê¨æ',
            'ËñÑËç∑ÁªøÊ¨æ'
        ];
        const LABUBU_COLORS = ['#FF69B4', '#8B4513', '#FF8C00', '#87CEEB', '#FFD700', '#9370DB', '#98FB98'];
        let board = [];
        let score = 0;
        let moves = 30;
        let level = 1;
        let selectedGem = null;
        let isProcessing = false;
        let shufflesLeft = 3;
        let combo = 0;
        let collectedLabubu = new Set();
        
        const gameBoard = document.getElementById('gameBoard');
        const scoreElement = document.getElementById('score');
        const movesElement = document.getElementById('moves');
        const levelElement = document.getElementById('level');
        const gameOverDiv = document.getElementById('gameOver');
        const overlay = document.getElementById('overlay');
        
        // ÂàõÂª∫Èü≥È¢ë‰∏ä‰∏ãÊñá
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // Êí≠ÊîæÂåπÈÖçÈü≥Êïà
        function playMatchSound() {
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            
            notes.forEach((freq, index) => {
                setTimeout(() => {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
                    
                    // Âä†ÂÖ•LABUBUÁöÑÂèØÁà±È¢§Èü≥
                    const vibrato = audioContext.createOscillator();
                    vibrato.frequency.value = 6;
                    const vibratoGain = audioContext.createGain();
                    vibratoGain.gain.value = 15;
                    vibrato.connect(vibratoGain);
                    vibratoGain.connect(oscillator.frequency);
                    vibrato.start();
                    
                    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                    vibrato.stop(audioContext.currentTime + 0.2);
                }, index * 100);
            });
        }
        
        // Êí≠ÊîæÈÄâÊã©Èü≥Êïà
        function playSelectSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // Êí≠ÊîæËøûÂáªÈü≥Êïà
        function playComboSound(comboLevel) {
            const baseFreq = 440 * (1 + comboLevel * 0.2);
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.type = 'triangle';
            oscillator.frequency.setValueAtTime(baseFreq, audioContext.currentTime);
            oscillator.frequency.exponentialRampToValueAtTime(baseFreq * 2, audioContext.currentTime + 0.3);
            
            gainNode.gain.setValueAtTime(0.4, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }
        
        // ÂàùÂßãÂåñÊ∏∏ÊàèÊùø
        function initBoard() {
            board = [];
            for (let row = 0; row < BOARD_SIZE; row++) {
                board[row] = [];
                for (let col = 0; col < BOARD_SIZE; col++) {
                    board[row][col] = getRandomGem();
                }
            }
            
            // Á°Æ‰øùÂºÄÂßãÊó∂Ê≤°ÊúâÂåπÈÖç
            while (hasMatches()) {
                shuffleBoardInternal();
            }
            
            renderBoard();
        }
        
        // Ëé∑ÂèñÈöèÊú∫ÂÆùÁü≥
        function getRandomGem() {
            return GEM_TYPES[Math.floor(Math.random() * GEM_TYPES.length)];
        }
        
        // Ê∏≤ÊüìÊ∏∏ÊàèÊùø
        function renderBoard() {
            gameBoard.innerHTML = '';
            
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    const gem = document.createElement('div');
                    gem.className = 'gem';
                    
                    // ÂàõÂª∫ÂõæÁâáÂÖÉÁ¥†
                    const img = document.createElement('img');
                    img.src = board[row][col];
                    img.alt = 'LABUBU';
                    gem.appendChild(img);
                    
                    gem.dataset.row = row;
                    gem.dataset.col = col;
                    
                    // Ê†πÊçÆLABUBUÁ±ªÂûãËÆæÁΩÆËæπÊ°ÜÈ¢úËâ≤
                    const gemIndex = GEM_TYPES.indexOf(board[row][col]);
                    if (gemIndex !== -1) {
                        gem.style.borderColor = LABUBU_COLORS[gemIndex];
                        gem.style.background = `${LABUBU_COLORS[gemIndex]}20`;
                    }
                    
                    gem.addEventListener('click', handleGemClick);
                    gem.addEventListener('touchstart', handleGemTouch);
                    
                    gameBoard.appendChild(gem);
                }
            }
        }
        
        // Â§ÑÁêÜÂÆùÁü≥ÁÇπÂáª
        function handleGemClick(e) {
            if (isProcessing) return;
            
            const row = parseInt(e.target.dataset.row);
            const col = parseInt(e.target.dataset.col);
            
            selectGem(row, col);
        }
        
        // Â§ÑÁêÜËß¶Êë∏‰∫ã‰ª∂
        function handleGemTouch(e) {
            e.preventDefault();
            if (isProcessing) return;
            
            const row = parseInt(e.target.dataset.row);
            const col = parseInt(e.target.dataset.col);
            
            selectGem(row, col);
        }
        
        // ÈÄâÊã©ÂÆùÁü≥
        function selectGem(row, col) {
            const gemElement = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            
            if (!selectedGem) {
                selectedGem = { row, col, element: gemElement };
                gemElement.classList.add('selected');
                playSelectSound();
            } else {
                // Ê£ÄÊü•ÊòØÂê¶Áõ∏ÈÇª
                const rowDiff = Math.abs(selectedGem.row - row);
                const colDiff = Math.abs(selectedGem.col - col);
                
                if ((rowDiff === 1 && colDiff === 0) || (rowDiff === 0 && colDiff === 1)) {
                    // Áõ∏ÈÇªÔºå‰∫§Êç¢
                    swapGems(selectedGem.row, selectedGem.col, row, col);
                } else {
                    // ‰∏çÁõ∏ÈÇªÔºåÈáçÊñ∞ÈÄâÊã©
                    selectedGem.element.classList.remove('selected');
                    selectedGem = { row, col, element: gemElement };
                    gemElement.classList.add('selected');
                    playSelectSound();
                }
            }
        }
        
        // ‰∫§Êç¢ÂÆùÁü≥
        async function swapGems(row1, col1, row2, col2) {
            isProcessing = true;
            
            // ‰∫§Êç¢Êï∞ÁªÑ‰∏≠ÁöÑÂÄº
            const temp = board[row1][col1];
            board[row1][col1] = board[row2][col2];
            board[row2][col2] = temp;
            
            // Êõ¥Êñ∞ÊòæÁ§∫
            updateGemDisplay(row1, col1);
            updateGemDisplay(row2, col2);
            
            // Ê∏ÖÈô§ÈÄâÊã©
            if (selectedGem) {
                selectedGem.element.classList.remove('selected');
                selectedGem = null;
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÊúâÂåπÈÖç
            const matches = findMatches();
            
            if (matches.length > 0) {
                // ÊúâÂåπÈÖçÔºåÂ§ÑÁêÜÂåπÈÖç
                moves--;
                movesElement.textContent = moves;
                combo = 0;
                await processMatches();
            } else {
                // Ê≤°ÊúâÂåπÈÖçÔºå‰∫§Êç¢ÂõûÊù•
                await new Promise(resolve => setTimeout(resolve, 300));
                const temp = board[row1][col1];
                board[row1][col1] = board[row2][col2];
                board[row2][col2] = temp;
                updateGemDisplay(row1, col1);
                updateGemDisplay(row2, col2);
            }
            
            isProcessing = false;
            
            // Ê£ÄÊü•Ê∏∏ÊàèÁªìÊùü
            if (moves <= 0) {
                gameOver();
            }
        }
        
        // Êõ¥Êñ∞ÂÆùÁü≥ÊòæÁ§∫
        function updateGemDisplay(row, col) {
            const gem = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
            gem.textContent = board[row][col];
        }
        
        // Êü•ÊâæÂåπÈÖç
        function findMatches() {
            const matches = [];
            
            // Ê£ÄÊü•Ê∞¥Âπ≥ÂåπÈÖç
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE - 2; col++) {
                    if (board[row][col] === board[row][col + 1] && 
                        board[row][col] === board[row][col + 2]) {
                        let matchLength = 3;
                        while (col + matchLength < BOARD_SIZE && 
                               board[row][col] === board[row][col + matchLength]) {
                            matchLength++;
                        }
                        
                        for (let i = col; i < col + matchLength; i++) {
                            matches.push({ row, col: i });
                        }
                    }
                }
            }
            
            // Ê£ÄÊü•ÂûÇÁõ¥ÂåπÈÖç
            for (let col = 0; col < BOARD_SIZE; col++) {
                for (let row = 0; row < BOARD_SIZE - 2; row++) {
                    if (board[row][col] === board[row + 1][col] && 
                        board[row][col] === board[row + 2][col]) {
                        let matchLength = 3;
                        while (row + matchLength < BOARD_SIZE && 
                               board[row][col] === board[row + matchLength][col]) {
                            matchLength++;
                        }
                        
                        for (let i = row; i < row + matchLength; i++) {
                            if (!matches.some(m => m.row === i && m.col === col)) {
                                matches.push({ row: i, col });
                            }
                        }
                    }
                }
            }
            
            return matches;
        }
        
        // Â§ÑÁêÜÂåπÈÖç
        async function processMatches() {
            let matches = findMatches();
            
            while (matches.length > 0) {
                combo++;
                
                // ËÆ∞ÂΩïÊî∂ÈõÜÂà∞ÁöÑLABUBU
                matches.forEach(match => {
                    const gemType = board[match.row][match.col];
                    const gemIndex = GEM_TYPES.indexOf(gemType);
                    if (gemIndex !== -1) {
                        collectedLabubu.add(gemIndex);
                    }
                });
                
                // Êí≠ÊîæÈü≥Êïà
                playMatchSound();
                if (combo > 1) {
                    playComboSound(combo);
                    showCombo(combo);
                }
                
                // Ê†áËÆ∞ÂåπÈÖçÁöÑÂÆùÁü≥
                matches.forEach(match => {
                    const gem = document.querySelector(`[data-row="${match.row}"][data-col="${match.col}"]`);
                    gem.classList.add('matched');
                });
                
                // ËÆ°ÁÆóÂàÜÊï∞
                const baseScore = matches.length * 10;
                const comboBonus = combo > 1 ? (combo - 1) * 50 : 0;
                score += baseScore + comboBonus;
                scoreElement.textContent = score;
                
                // Á≠âÂæÖÂä®Áîª
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ÁßªÈô§ÂåπÈÖçÁöÑÂÆùÁü≥
                matches.forEach(match => {
                    board[match.row][match.col] = null;
                });
                
                // ‰∏ãËêΩ
                await dropGems();
                
                // Â°´ÂÖÖÊñ∞ÂÆùÁü≥
                fillBoard();
                
                // Ê∏≤Êüì
                renderBoard();
                
                // Êü•ÊâæÊñ∞ÁöÑÂåπÈÖç
                matches = findMatches();
            }
            
            // Ê£ÄÊü•ÊòØÂê¶ÂçáÁ∫ß
            checkLevelUp();
            
            // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÂèØËÉΩÁöÑÁßªÂä®
            if (!hasPossibleMoves()) {
                shuffleBoardInternal();
                renderBoard();
            }
        }
        
        // ÂÆùÁü≥‰∏ãËêΩ
        async function dropGems() {
            for (let col = 0; col < BOARD_SIZE; col++) {
                let emptyRow = BOARD_SIZE - 1;
                
                for (let row = BOARD_SIZE - 1; row >= 0; row--) {
                    if (board[row][col] !== null) {
                        if (row !== emptyRow) {
                            board[emptyRow][col] = board[row][col];
                            board[row][col] = null;
                        }
                        emptyRow--;
                    }
                }
            }
        }
        
        // Â°´ÂÖÖÁ©∫‰Ωç
        function fillBoard() {
            for (let col = 0; col < BOARD_SIZE; col++) {
                for (let row = 0; row < BOARD_SIZE; row++) {
                    if (board[row][col] === null) {
                        board[row][col] = getRandomGem();
                        const gem = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                        if (gem) {
                            gem.classList.add('falling');
                        }
                    }
                }
            }
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂåπÈÖç
        function hasMatches() {
            return findMatches().length > 0;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶ÊúâÂèØËÉΩÁöÑÁßªÂä®
        function hasPossibleMoves() {
            // Ê£ÄÊü•ÊâÄÊúâÂèØËÉΩÁöÑ‰∫§Êç¢
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    // Ê£ÄÊü•Âè≥Ëæπ‰∫§Êç¢
                    if (col < BOARD_SIZE - 1) {
                        swap(row, col, row, col + 1);
                        if (hasMatches()) {
                            swap(row, col, row, col + 1); // Êç¢ÂõûÊù•
                            return true;
                        }
                        swap(row, col, row, col + 1); // Êç¢ÂõûÊù•
                    }
                    
                    // Ê£ÄÊü•‰∏ãÈù¢‰∫§Êç¢
                    if (row < BOARD_SIZE - 1) {
                        swap(row, col, row + 1, col);
                        if (hasMatches()) {
                            swap(row, col, row + 1, col); // Êç¢ÂõûÊù•
                            return true;
                        }
                        swap(row, col, row + 1, col); // Êç¢ÂõûÊù•
                    }
                }
            }
            
            return false;
        }
        
        // ‰∫§Êç¢ÔºàÂÜÖÈÉ®‰ΩøÁî®Ôºâ
        function swap(row1, col1, row2, col2) {
            const temp = board[row1][col1];
            board[row1][col1] = board[row2][col2];
            board[row2][col2] = temp;
        }
        
        // ÈáçÊñ∞ÊéíÂàó
        function shuffleBoard() {
            if (shufflesLeft > 0 && !isProcessing) {
                shufflesLeft--;
                shuffleBoardInternal();
                renderBoard();
                
                // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
                const shuffleBtn = document.querySelector('.special-button');
                shuffleBtn.textContent = `ÈáçÊñ∞ÊéíÂàó (${shufflesLeft}Ê¨°)`;
                
                if (shufflesLeft === 0) {
                    shuffleBtn.disabled = true;
                }
            }
        }
        
        // ÂÜÖÈÉ®ÈáçÊñ∞ÊéíÂàó
        function shuffleBoardInternal() {
            // Êî∂ÈõÜÊâÄÊúâÂÆùÁü≥
            const gems = [];
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    gems.push(board[row][col]);
                }
            }
            
            // Êâì‰π±
            for (let i = gems.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [gems[i], gems[j]] = [gems[j], gems[i]];
            }
            
            // ÊîæÂõû
            let index = 0;
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    board[row][col] = gems[index++];
                }
            }
        }
        
        // ÊòæÁ§∫ÊèêÁ§∫
        function showHint() {
            if (isProcessing) return;
            
            // ÊâæÂà∞‰∏Ä‰∏™ÂèØËÉΩÁöÑÁßªÂä®
            for (let row = 0; row < BOARD_SIZE; row++) {
                for (let col = 0; col < BOARD_SIZE; col++) {
                    // Ê£ÄÊü•Âè≥Ëæπ‰∫§Êç¢
                    if (col < BOARD_SIZE - 1) {
                        swap(row, col, row, col + 1);
                        if (hasMatches()) {
                            swap(row, col, row, col + 1); // Êç¢ÂõûÊù•
                            
                            // È´ò‰∫ÆËøô‰∏§‰∏™ÂÆùÁü≥
                            const gem1 = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                            const gem2 = document.querySelector(`[data-row="${row}"][data-col="${col + 1}"]`);
                            
                            gem1.classList.add('selected');
                            gem2.classList.add('selected');
                            
                            setTimeout(() => {
                                gem1.classList.remove('selected');
                                gem2.classList.remove('selected');
                            }, 1000);
                            
                            return;
                        }
                        swap(row, col, row, col + 1); // Êç¢ÂõûÊù•
                    }
                    
                    // Ê£ÄÊü•‰∏ãÈù¢‰∫§Êç¢
                    if (row < BOARD_SIZE - 1) {
                        swap(row, col, row + 1, col);
                        if (hasMatches()) {
                            swap(row, col, row + 1, col); // Êç¢ÂõûÊù•
                            
                            // È´ò‰∫ÆËøô‰∏§‰∏™ÂÆùÁü≥
                            const gem1 = document.querySelector(`[data-row="${row}"][data-col="${col}"]`);
                            const gem2 = document.querySelector(`[data-row="${row + 1}"][data-col="${col}"]`);
                            
                            gem1.classList.add('selected');
                            gem2.classList.add('selected');
                            
                            setTimeout(() => {
                                gem1.classList.remove('selected');
                                gem2.classList.remove('selected');
                            }, 1000);
                            
                            return;
                        }
                        swap(row, col, row + 1, col); // Êç¢ÂõûÊù•
                    }
                }
            }
        }
        
        // ÊòæÁ§∫ËøûÂáª
        function showCombo(comboLevel) {
            const popup = document.createElement('div');
            popup.className = 'combo-popup';
            
            if (typeof comboLevel === 'number') {
                const labubuMessages = [
                    'Â§™Ê£í‰∫ÜÔºÅÂ∏ÉÂ∏É‰ª¨Âú®Ë∑≥ËàûÔºÅ',
                    'LABUBUÂÆ∂Êóè‰∏∫‰Ω†Ê¨¢ÂëºÔºÅ',
                    'ÂìáÔºÅÂ∏ÉÂ∏ÉËøûÂáªÔºÅ',
                    'Á•ûÂ•áÁöÑÂ∏ÉÂ∏ÉÈ≠îÊ≥ïÔºÅ',
                    'Â∏ÉÂ∏É‰ª¨Â•ΩÂºÄÂøÉÔºÅ'
                ];
                const randomMessage = labubuMessages[Math.floor(Math.random() * labubuMessages.length)];
                popup.textContent = `${comboLevel}ËøûÂáªÔºÅ${randomMessage}`;
            } else {
                popup.textContent = comboLevel;
            }
            
            popup.style.left = '50%';
            popup.style.top = '50%';
            popup.style.transform = 'translate(-50%, -50%)';
            
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.remove();
            }, 1500);
        }
        
        // Ê£ÄÊü•ÂçáÁ∫ß
        function checkLevelUp() {
            const targetScore = level * 500;
            if (score >= targetScore) {
                level++;
                levelElement.textContent = level;
                moves += 10; // Â•ñÂä±10Ê≠•
                movesElement.textContent = moves;
                
                showCombo(`Á¨¨${level}ÂÖ≥ÔºÅ`);
            }
        }
        
        // ÊòæÁ§∫Êî∂Ëóè
        function showCollection() {
            const collectionModal = document.getElementById('collectionModal');
            const collectionList = document.getElementById('collectionList');
            
            collectionList.innerHTML = '';
            
            LABUBU_NAMES.forEach((name, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'padding: 10px; margin: 5px; border-radius: 10px; display: flex; align-items: center; gap: 10px;';
                
                if (collectedLabubu.has(index)) {
                    item.style.background = LABUBU_COLORS[index] + '30';
                    item.innerHTML = `
                        <img src="${GEM_TYPES[index]}" style="width: 40px; height: 40px; object-fit: contain;">
                        <span style="color: ${LABUBU_COLORS[index]}; font-weight: bold;">‚úì ${name}</span>
                    `;
                } else {
                    item.style.background = '#f0f0f0';
                    item.innerHTML = `
                        <span style="font-size: 24px;">‚ùì</span>
                        <span style="color: #999;">Êú™Êî∂ÈõÜ</span>
                    `;
                }
                
                collectionList.appendChild(item);
            });
            
            const progress = document.createElement('p');
            progress.style.cssText = 'text-align: center; margin-top: 20px; font-weight: bold; color: #666;';
            progress.textContent = `Êî∂ÈõÜËøõÂ∫¶Ôºö${collectedLabubu.size}/7`;
            collectionList.appendChild(progress);
            
            overlay.style.display = 'block';
            collectionModal.style.display = 'block';
        }
        
        // ÂÖ≥Èó≠Êî∂Ëóè
        function closeCollection() {
            const collectionModal = document.getElementById('collectionModal');
            overlay.style.display = 'none';
            collectionModal.style.display = 'none';
        }
        
        // Ê∏∏ÊàèÁªìÊùü
        function gameOver() {
            const finalScoreElement = document.getElementById('finalScore');
            const gameOverTitle = document.getElementById('gameOverTitle');
            const gameOverMessage = document.getElementById('gameOverMessage');
            const collectedCountElement = document.getElementById('collectedCount');
            
            finalScoreElement.textContent = score;
            collectedCountElement.textContent = collectedLabubu.size;
            
            if (score >= 1000) {
                gameOverTitle.textContent = 'Â§™Ê£í‰∫ÜÔºÅ';
                gameOverMessage.textContent = '‰Ω†ÊòØLABUBUÊî∂ËóèÂ§ßÂ∏àÔºÅ';
            } else if (score >= 500) {
                gameOverTitle.textContent = 'ÂÅöÂæó‰∏çÈîôÔºÅ';
                gameOverMessage.textContent = 'ÁªßÁª≠Êî∂ÈõÜÊõ¥Â§öLABUBUÂêßÔºÅ';
            } else {
                gameOverTitle.textContent = 'Ê∏∏ÊàèÁªìÊùü';
                gameOverMessage.textContent = 'LABUBU‰ª¨Âú®Á≠â‰Ω†ÂÜçÊù•Áé©ÔºÅ';
            }
            
            overlay.style.display = 'block';
            gameOverDiv.style.display = 'block';
        }
        
        // Êñ∞Ê∏∏Êàè
        function newGame() {
            score = 0;
            moves = 30;
            level = 1;
            shufflesLeft = 3;
            combo = 0;
            selectedGem = null;
            isProcessing = false;
            
            scoreElement.textContent = score;
            movesElement.textContent = moves;
            levelElement.textContent = level;
            
            const shuffleBtn = document.querySelector('.special-button');
            shuffleBtn.textContent = 'ÈáçÊñ∞ÊéíÂàó (3Ê¨°)';
            shuffleBtn.disabled = false;
            
            overlay.style.display = 'none';
            gameOverDiv.style.display = 'none';
            
            initBoard();
        }
        
        // ÂàùÂßãÂåñÊ∏∏Êàè
        initBoard();
    </script>
</body>
</html>
